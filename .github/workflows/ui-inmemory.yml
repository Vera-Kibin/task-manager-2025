# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Test UI-inmemory

on:
  push:
    branches: ["main"]
    paths:
      - "web/**"
      - "app/**"
      - "requirements.txt"
      - ".github/workflows/ui-inmemory.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "web/**"
      - "app/**"
      - "requirements.txt"
      - ".github/workflows/ui-inmemory.yml"

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Lint with flake8
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Start Flask API (in-memory)
        run: |
          export FLASK_APP="app.api:create_app"
          export FLASK_ENV=development
          export PYTHONPATH=$GITHUB_WORKSPACE
          flask run --host 127.0.0.1 --port 5000 &
          sleep 3

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Install frontend deps
        working-directory: web
        run: npm ci

      - name: Install Playwright browsers
        working-directory: web
        run: npx playwright install --with-deps

      - name: Start Vite dev server
        working-directory: web
        env:
          VITE_API_URL: http://127.0.0.1:5000
        run: |
          npm run dev -- --host 127.0.0.1 --port 5173 --strictPort &
          npx -y wait-on tcp:127.0.0.1:5173

      - name: Run Playwright tests
        working-directory: web
        env:
          CI: true
        run: npx playwright test --reporter=line,html

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: web/playwright-report
          if-no-files-found: ignore

      - name: Upload test results (traces, screenshots)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: web/test-results
          if-no-files-found: ignore
